# Versioned Patches

This directory contains versioned, ready-to-use patch files generated from templates in `../templates/`.

## Files

### `docker_db.sh.tidb-patched`

**Purpose:** Hardened TiDB setup function for Hibernate ORM's `docker_db.sh` script.

**Generated from:** `../templates/docker_db.sh.tidb-function`

**Generated by:** `../patch_docker_db_tidb.py`

**Contains:**
- `tidb()` function with all TiDB-specific fixes
- `tidb_5_4()` fallback function

**How to use:**

1. **Apply to workspace:** Run the patch script (recommended):
   ```bash
   python3 scripts/patch_docker_db_tidb.py "$WORKSPACE_DIR"
   ```

2. **Manual application:** Copy relevant sections to your `docker_db.sh`:
   ```bash
   # Extract tidb() function from this patch and insert into docker_db.sh
   ```

3. **Compare with upstream:** Diff against Hibernate's current version:
   ```bash
   # Download upstream
   curl -s https://raw.githubusercontent.com/hibernate/hibernate-orm/main/docker_db.sh > /tmp/upstream-docker_db.sh

   # Extract and compare tidb() functions
   sed -n '/^tidb()/,/^}/p' /tmp/upstream-docker_db.sh > /tmp/upstream-tidb.sh
   diff -u /tmp/upstream-tidb.sh scripts/patches/docker_db.sh.tidb-patched
   ```

**Features:**
- Headless compatibility (no `-it` flag for non-interactive environments)
- TiDB v8.5.3 LTS image (updated from v5.4.3)
- Hardened readiness checks (log + ping probes, ~75s timeout)
- Retry logic for bootstrap SQL (3 attempts)
- Post-bootstrap verification (confirms user/schema exist)
- Main database and user creation embedded inline
- Optional bootstrap SQL injection (for strict/permissive configurations)

**Version Control:**
This file is git-tracked and regenerated whenever:
- The template is updated
- Bootstrap SQL configuration changes
- The patch script is run

**Last Generated:** Check git log for this file's modification date